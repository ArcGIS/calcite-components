<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Autocomplete</title>
    <script src="_assets/head.ts"></script>
    <style>
      .parent {
        display: flex;
        width: 85%;
        align-items: center;
        padding: 15px 0;
      }

      .child {
        flex: 1 0 15%;
        margin: 0 25px;
        color: var(--calcite-color-text-3);
        font-family: var(--calcite-font-family);
        font-size: var(--calcite-font-size-0);
        font-weight: var(--calcite-font-weight-medium);
      }

      .right-aligned-text {
        text-align: right;
      }

      hr {
        margin: 25px 0;
        border-top: 1px solid var(--calcite-color-border-2);
      }
    </style>
  </head>

  <body>
    <demo-dom-swapper>
      <h1 style="margin: 0; text-align: center">Autocomplete</h1>

      <div class="parent">
        <div class="child right-aligned-text">Locator example</div>
        <div class="child">
          <form class="locate-form">
            <calcite-autocomplete
              class="locator-autocomplete"
              name="test"
              required
              id="locator"
              scale="m"
            ></calcite-autocomplete>
          </form>
          <calcite-alert id="locator-alert" kind="brand"></calcite-alert>

          <script type="module">
            import { suggestLocations } from "https://js.arcgis.com/4.29/@arcgis/core/rest/locator.js";

            async function getSuggestions(locatorAutocomplete) {
              locatorAutocomplete.innerHTML = "";

              locatorAutocomplete.open = true;

              if (!locatorAutocomplete.inputValue) {
                const emptyText = document.createElement("calcite-notice");
                emptyText.open = true;
                emptyText.icon = "information";
                emptyText.kind = "brand";
                emptyText.innerHTML = `
          <div slot="title">Empty text</div>
    <div slot="message">Enter some text</div>`;
                emptyText.slot = "content-bottom";
                locatorAutocomplete.appendChild(emptyText);
                return;
              }

              const response = await suggestLocations(
                "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",
                {
                  text: locatorAutocomplete.inputValue,
                },
              );

              if (response.length === 0) {
                locatorAutocomplete.innerHTML = "";
                const noResults = document.createElement("calcite-notice");
                noResults.open = true;
                noResults.kind = "danger";
                noResults.icon = "exclamation-mark-triangle";
                noResults.innerHTML = `
          <div slot="title">No results</div>
    <div slot="message">Try something else</div>`;
                noResults.slot = "content-top";
                locatorAutocomplete.appendChild(noResults);
              } else {
                locatorAutocomplete.innerHTML = "";
                response.forEach((location) => {
                  const item = document.createElement("calcite-autocomplete-item");
                  item.value = location.magicKey;
                  item.heading = location.text;
                  locatorAutocomplete.appendChild(item);
                });
              }

              return response;
            }

            const locateForms = document.querySelectorAll(".locate-form");

            locateForms.forEach((form) => {
              form.addEventListener("submit", (event) => {
                event.preventDefault();
                const data = new FormData(event.target);
                console.log([...data.entries()]);
              });
            });

            const locatorAutocompletes = document.querySelectorAll(".locator-autocomplete");

            locatorAutocompletes.forEach((locatorAutocomplete) => {
              let results, lastSuggestQuery;

              locatorAutocomplete.addEventListener("calciteAutocompleteTextInput", async (event) => {
                const inputValue = event.target.inputValue;

                if (!inputValue) {
                  locatorAutocomplete.value = "";
                }

                const alert = document.getElementById("locator-alert");
                alert.open = false;

                locatorAutocomplete.loading = true;

                const suggestQuery = getSuggestions(locatorAutocomplete);
                lastSuggestQuery = suggestQuery;

                setTimeout(() => {
                  if (suggestQuery !== lastSuggestQuery) {
                    return;
                  }
                  locatorAutocomplete.loading = false;
                }, 500);

                results = await suggestQuery;
              });

              locatorAutocomplete.addEventListener("calciteAutocompleteChange", (event) => {
                console.log({ name: "calciteAutocompleteChange", event, value: event.target.value });
                const selected = results.find((result) => result.magicKey === event.target.value);
                locatorAutocomplete.inputValue = selected?.text;
                const alert = document.getElementById("locator-alert");
                alert.innerHTML = `<div slot="title">Selected item</div>
        <div slot="message">You selected "${selected?.text}"</div>`;
                alert.open = true;
              });
            });
          </script>
        </div>
      </div>
    </demo-dom-swapper>
  </body>
</html>
